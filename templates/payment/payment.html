{% extends 'base.html' %}
{% load static %}
{% block content %}
  <script src="https://scripts.sandbox.bka.sh/versions/1.2.0-beta/checkout/bKash-checkout-sandbox.js"></script>
  <section class="section-content padding-y bg">
    <div class="container">
      <div class="row justify-content-center">
        <aside class="col-md-8">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title mb-4">Complete Your Payment</h4>
              <p><strong>Order Total:</strong> {{ order.grand_total | floatformat:2 }}TK</p>
              <hr>
              {% include 'footer/alarts.html' %}
              {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                  {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}

              <form action="{% url 'payments' %}" method="POST">
                {% csrf_token %}
                <div class="form-group">
                  <label class="font-weight-bold">Select Payment Method:</label><br>
                  {% for value, name in form.payment_method.field.choices %}
                    <div class="form-check m-3">
                      <input class="form-check-input" type="radio" name="payment_method" id="payment_{{ value }}" value="{{ value }}"
                      {% if form.payment_method.value|stringformat:"s" == value|stringformat:"s" %}checked{% endif %} required>
                        <label class="form-check-label" for="payment_{{ value }}">
                          <strong>{{ name }}</strong>
                        </label>     
                    </div>
                  {% endfor %}
                  {% if form.payment_method.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.payment_method.errors.as_text }}
                    </div>
                  {% endif %}
                </div>
                <div id="mobile_payment_fields" class="payment-fields" style="display:none;">
                  <h5 class="mt-3">Mobile Payment Details</h5>
                  <p class="text-muted">Please complete your payment and enter the details below.</p>
                  <div class="form-group">
                    <label for="{{ form.mobile_number.id_for_label }}">{{ form.mobile_number.label }}</label>
                    {{ form.mobile_number }}
                    <small class="form-text text-danger">{{ form.mobile_number.errors.as_text }}</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="{{ form.transaction_id.id_for_label }}">{{ form.transaction_id.label }}</label>
                    {{ form.transaction_id }}
                    <small class="form-text text-danger">{{ form.transaction_id.errors.as_text }}</small>
                  </div>
                </div>
                <div id="card_payment_fields" class="payment-fields" style="display:none;">
                  <h5 class="mt-3">Card Payment Details</h5>
                  <div class="form-group">
                    <label for="{{ form.card_holder_name.id_for_label }}">{{ form.card_holder_name.label }}</label>
                    {{ form.card_holder_name }}
                    <small class="form-text text-danger">{{ form.card_holder_name.errors.as_text }}</small>
                  </div>
                  <div class="form-group">
                    <label for="{{ form.card_number.id_for_label }}">{{ form.card_number.label }}</label>
                    {{ form.card_number }}
                    <small class="form-text text-danger">{{ form.card_number.errors.as_text }}</small>
                  </div>
                </div>
                <div id="emi_fields" class="payment-fields" style="display:none;">
                  <h5 class="mt-3">EMI Option</h5>
                  <div class="form-group">
                    <label for="{{ form.emi_month.id_for_label }}">{{ form.emi_month.label }}</label>
                    {% for value, name in form.emi_month.field.choices %}
                      <div class="form-check ml-3"> <input class="form-check-input" type="radio" name="{{ form.emi_month.name }}" id="id_emi_month_{{ forloop.counter }}" value="{{ value }}" {% if form.emi_month.value|stringformat:"s" == value|stringformat:"s" %}checked{% endif %}>
                        <label class="form-check-label" for="id_emi_month_{{ forloop.counter }}">
                          {{ name }}
                        </label>
                      </div>
                    {% endfor %}
                    <small class="form-text text-danger">{{ form.emi_month.errors.as_text }}</small>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary btn-block mt-4">Payment {{ order.grand_total | floatformat:2 }} TK</button>
                <br> OR
                <button type="submit" class="btn btn-primary btn-block mt-4">Download Invoice </button>
              </form>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const bkashRadio = document.getElementById('payment_bkash');
      const paymentForm = document.querySelector('form');
      if (bkashRadio) {
        paymentForm.addEventListener('submit', function(e) {
          if (bkashRadio.checked) {
            e.preventDefault();
            initiateBkashPayment();
          }
        });
      }
      function initiateBkashPayment() {
        const orderId = {{ order.id }};
        fetch(`/payments/bkash/initiate/${orderId}/`, {
          method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            }

        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = data.bkash_url;
          } else {
            alert('bKash payment initiation failed: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Payment initiation failed');

        });
      }
    });
    
  </script>
{% endblock %}